{% extends 'transactions/base.html' %}
{% block title %}
Matrice de Corrélation - DRC Transactions
{% endblock %}

{% block content %}
    {% include 'transactions/reports/nav.html' %}    

    <div class="container-fluid mt-4" x-data="sectorFilter()" x-init="fetchUniqueSectors()">
        <h1 class="mb-4">Matrice des Echanges Economiques</h1>

        <form method="get" class="mb-4">
            <!-- Secteur d'activité -->
            <div class="mb-4">
                <label for="sector_label" class="block text-sm font-medium text-gray-700 dark:text-gray-400">Secteur d'activité :</label>
                <select id="sector_label" x-model="client.sector_label" @change="updateSectorLabel" class="block w-full mt-1 text-sm dark:border-gray-600 dark:bg-gray-700 focus:border-purple-400 focus:outline-none focus:shadow-outline-purple dark:text-gray-300 dark:focus:shadow-outline-gray form-select">
                    <template x-for="unique_sector in uniqueSectors" :key="unique_sector.id">
                        <option :value="unique_sector.sector_label" x-text="unique_sector.sector_label"></option>
                    </template>
                </select>
            </div>
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    {{ filter.form.as_p }}
                </div>
                <div class="col-auto">
                    <button type="submit" 
                    class="px-4 py-2 text-sm font-medium leading-5 text-white transition-colors duration-150 bg-purple-600 border border-transparent rounded-lg active:bg-purple-600 hover:bg-purple-700 focus:outline-none focus:shadow-outline-purple"
                    >
                    Filter</button>
                </div>
            </div>
        </form>

        <div id="matrix-container">
            <h2>Matrices des Ventes (Producteurs-Clients)</h2>
            <button id="toggleLabelsSales" class="btn btn-secondary mb-3">Afficher/Cacher Étiquettes</button>
            <div id="salesMatrixChart" style="height: 1000px; width: 100%;"></div>
            <h2>Matrice des Achats (Producteurs-Fournisseurs)</h2>
            <button id="toggleLabelsPurchase" class="btn btn-secondary mb-3">Afficher/Cacher Étiquettes</button>
            <div id="purchaseMatrixChart" style="height: 1000px; width: 100%;"></div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/alpine.min.js" defer></script>
        <script>
            function sectorFilter() {
                return {
                    uniqueSectors: [],
                    client: {
                        sector_label: ''
                    },
                    async fetchUniqueSectors() {
                        try {
                            const response = await fetch('/api/unique-sectors/');
                            if (!response.ok) {
                                throw new Error('Erreur réseau lors de la récupération des secteurs uniques.');
                            }
                            this.uniqueSectors = await response.json();
                        } catch (error) {
                            console.error('Erreur fetching unique sectors:', error);
                        }
                    },

                    // Mettre à jour le label de secteur sélectionné
                    async updateSectorLabel() {
                        try {
                            const response = await fetch(`/api/products/?sector_label=${encodeURIComponent(this.client.sector_label)}`);
                            if (!response.ok) {
                                throw new Error('Erreur réseau lors de la récupération des produits.');
                            }
                            const products = await response.json();

                            // Vous pouvez maintenant utiliser les données des produits pour mettre à jour votre matrice
                            console.log('Products filtered:', products);

                            // Exemple de mise à jour du graphique après filtrage
                            // Par exemple, recharger le graphique avec les nouvelles données filtrées
                            // Assurez-vous d'avoir une fonction appropriée pour mettre à jour le graphique
                            // createHeatmap('salesMatrixChart', newData, 'Matrice de Ventes (Producteurs -Clients)');
                        } catch (error) {
                            console.error('Erreur fetching filtered products:', error);
                        }
                    }
                };
            }
        </script>
        
        <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const data = {{ data_json|safe }};
                
                createHeatmap('salesMatrixChart', data.sales_heatmap_data, "Matrice de Ventes (Producteurs -Clients)");
                createHeatmap('purchaseMatrixChart', data.purchase_heatmap_data, "Matrice d'Achats (Producteurs -Fournisseurs)");

                document.getElementById('toggleLabelsSales').addEventListener('click', function() {
                    toggleDataLabels('salesMatrixChart');
                });

                document.getElementById('toggleLabelsPurchase').addEventListener('click', function() {
                    toggleDataLabels('purchaseMatrixChart');
                });
            });

            function createHeatmap(elementId, heatmapData, titleText) {
                var options = {
                    series: heatmapData.map(provinceData => ({
                        name: provinceData.name,
                        data: provinceData.data.map(d => ({
                            x: d.x,
                            y: d.y,
                            quantity: d.quantity
                        }))
                    })),
                    chart: {
                        height: 1000,  // Increase the height of the chart to 1000px
                        type: 'heatmap',
                        toolbar: {
                            show: true
                        }
                    },
                    stroke: {
                        width: 1
                    },
                    plotOptions: {
                        heatmap: {
                            radius: 0,
                            enableShades: true,
                            colorScale: {
                                ranges: [
                                    {
                                        from: 0,
                                        to: 10,
                                        color: '#00A100'
                                    },
                                    {
                                        from: 11,
                                        to: 20,
                                        color: '#128FD9'
                                    },
                                    {
                                        from: 21,
                                        to: 30,
                                        color: '#FFB200'
                                    },
                                    {
                                        from: 31,
                                        to: 40,
                                        color: '#FF0000'
                                    }
                                ],
                            },
                        }
                    },
                    dataLabels: {
                        enabled: false  // Start with data labels disabled
                    },
                    xaxis: {
                        type: 'category',
                        labels: {
                            rotate: -45,
                            style: {
                                fontSize: '12px',
                            }
                        }
                    },
                    yaxis: {
                        labels: {
                            style: {
                                fontSize: '12px',
                            }
                        }
                    },
                    title: {
                        text: titleText,
                        align: 'center',
                        style: {
                            fontSize: '18px',
                            color: '#333'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        y: {
                            formatter: function(value, { seriesIndex, dataPointIndex, w }) {
                                const data = w.globals.initialSeries[seriesIndex].data[dataPointIndex];
                                return `Prix: ${value.toFixed(2)}<br>Qté: ${data.quantity}`;
                            }
                        }
                    }
                };

                var chart = new ApexCharts(document.querySelector(`#${elementId}`), options);
                chart.render();
                chart.toggleDataLabels = function() {
                    this.updateOptions({
                        dataLabels: {
                            enabled: !this.w.globals.initialConfig.dataLabels.enabled
                        }
                    });
                    this.w.globals.initialConfig.dataLabels.enabled = !this.w.globals.initialConfig.dataLabels.enabled;
                };
                window[elementId] = chart;  // Store the chart instance in the window object for easy access
            }

            function toggleDataLabels(chartId) {
                window[chartId].toggleDataLabels();
            }
        </script>
    </div>
{% endblock %}
