{% extends 'transactions/base.html' %}
{% block title %}
Matrice de Corrélation - DRC Transactions
{% endblock %}

{% block content %}
    {% include 'transactions/reports/nav.html' %}    

  <div class="container-fluid mt-4" x-data="sectorFilter()" x-init="fetchUniqueSectors()">
    <h1 class="mb-4">Matrice des Echanges Economiques</h1>

    <form method="get" class="mb-4">
        
    <!-- Secteur d'activité -->
    <div class="mb-4">
        <label for="sector_label" class="block text-sm font-medium text-gray-700 dark:text-gray-400">Secteur d'activité :</label>
        <select id="sector_label" x-model="client.sector_label" @change="updateSectorLabel" class="block w-full mt-1 text-sm dark:border-gray-600 dark:bg-gray-700 focus:border-purple-400 focus:outline-none focus:shadow-outline-purple dark:text-gray-300 dark:focus:shadow-outline-gray form-select">
            <template x-for="unique_sector in uniqueSectors" :key="unique_sector.id">
                <option :value="unique_sector.sector_label" x-text="unique_sector.sector_label"></option>
            </template>
        </select>
    </div>
        <div class="row g-3 align-items-center">
            <div class="col-auto">
                {{ filter.form.as_p }}
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </div>
    </form>

    <div id="matrix-container">
        <h2>Matrices des Ventes (Producteurs-Clients)</h2>
        <div id="salesMatrixChart"></div>
        <h2>Matrice des Achats (Producteurs-Fournisseurs)</h2>
        <div id="purchaseMatrixChart"></div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/alpine.min.js" defer></script>
    <script>
        function sectorFilter() {
            return {
                uniqueSectors: [],
                client: {
                    sector_label: ''
                },
                async fetchUniqueSectors() {
                    try {
                        const response = await fetch('/api/unique-sectors/');
                        if (!response.ok) {
                            throw new Error('Erreur réseau lors de la récupération des secteurs uniques.');
                        }
                        this.uniqueSectors = await response.json();
                    } catch (error) {
                        console.error('Erreur fetching unique sectors:', error);
                    }
                },
    
                // Mettre à jour le label de secteur sélectionné
                async updateSectorLabel() {
                    try {
                        const response = await fetch(`/api/products/?sector_label=${encodeURIComponent(this.client.sector_label)}`);
                        if (!response.ok) {
                            throw new Error('Erreur réseau lors de la récupération des produits.');
                        }
                        const products = await response.json();
    
                        // Vous pouvez maintenant utiliser les données des produits pour mettre à jour votre matrice
                        console.log('Products filtered:', products);
    
                        // Exemple de mise à jour du graphique après filtrage
                        // Par exemple, recharger le graphique avec les nouvelles données filtrées
                        // Assurez-vous d'avoir une fonction appropriée pour mettre à jour le graphique
                        // createHeatmap('salesMatrixChart', newData, 'Sales Matrix (Producers-Clients)');
                    } catch (error) {
                        console.error('Erreur fetching filtered products:', error);
                    }
                }
            };
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const data = {{ data_json|safe }};
            
            createHeatmap('salesMatrixChart', data.sales_heatmap_data, 'Sales Matrix (Producers-Clients)');
            createHeatmap('purchaseMatrixChart', data.purchase_heatmap_data, 'Purchase Matrix (Producers-Suppliers)');
        });

        function createHeatmap(elementId, heatmapData, titleText) {
            var options = {
                series: heatmapData.map(provinceData => ({
                    name: provinceData.name,
                    data: provinceData.data.map(d => ({
                        x: d.x,
                        y: d.y,
                        quantity: d.quantity
                    }))
                })),
                chart: {
                    height: 350,
                    type: 'heatmap',
                },
                stroke: {
                    width: 0
                },
                plotOptions: {
                    heatmap: {
                        radius: 30,
                        enableShades: false,
                        colorScale: {
                            ranges: [{
                                from: 0,
                                to: 50,
                                color: '#008FFB'
                            },
                            {
                                from: 51,
                                to: 100,
                                color: '#00E396'
                            }],
                        },
                    }
                },
                dataLabels: {
                    enabled: true,
                    style: {
                        colors: ['#fff']
                    },
                    formatter: function(value, { seriesIndex, dataPointIndex, w }) {
                        const data = w.globals.initialSeries[seriesIndex].data[dataPointIndex];
                        return `Prix: ${value}
                        Qté: ${data.quantity}`;
                    }
                },
                xaxis: {
                    type: 'category',
                },
                title: {
                    text: titleText
                },
                tooltip: {
                    enabled: true,
                    y: {
                        formatter: function(value, { seriesIndex, dataPointIndex, w }) {
                            const data = w.globals.initialSeries[seriesIndex].data[dataPointIndex];
                            return `Price: ${value}<br>Qty: ${data.quantity}`;
                        }
                    }
                }
            };

            var chart = new ApexCharts(document.querySelector(`#${elementId}`), options);
            chart.render();
        }
    </script>
</div>
{% endblock %}



{% comment %} {% extends 'transactions/base.html' %}

{% block title %}Matrice de Corrélation - DRC Transactions{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="mb-4">Correlation Matrix</h1>

    <form method="get" class="mb-4">
        <div class="row g-3 align-items-center">
            <div class="col-auto">
                {{ filter.form.as_p }}
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </div>
    </form>

    <div id="matrix-container">
        <h2>Sales Matrix (Producers-Clients)</h2>
        <div id="salesMatrixChart"></div>
        <h2>Purchase Matrix (Producers-Suppliers)</h2>
        <div id="purchaseMatrixChart"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const data = {{ data_json|safe }};
            
            createHeatmap('salesMatrixChart', data.sales_heatmap_data, 'Sales Matrix (Producers-Clients)');
            createHeatmap('purchaseMatrixChart', data.purchase_heatmap_data, 'Purchase Matrix (Producers-Suppliers)');
        });

        function createHeatmap(elementId, heatmapData, titleText) {
            var options = {
                series: heatmapData,
                chart: {
                    height: 350,
                    type: 'heatmap',
                },
                stroke: {
                    width: 0
                },
                plotOptions: {
                    heatmap: {
                        radius: 30,
                        enableShades: false,
                        colorScale: {
                            ranges: [{
                                from: 0,
                                to: 50,
                                color: '#008FFB'
                            },
                            {
                                from: 51,
                                to: 100,
                                color: '#00E396'
                            }],
                        },
                    }
                },
                dataLabels: {
                    enabled: true,
                    style: {
                        colors: ['#fff']
                    }
                },
                xaxis: {
                    type: 'category',
                },
                title: {
                    text: titleText
                },
            };

            var chart = new ApexCharts(document.querySelector(`#${elementId}`), options);
            chart.render();
        }
    </script>
</div>
{% endblock %} {% endcomment %}
